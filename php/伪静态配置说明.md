# Nginx 伪静态配置详解

## 📝 配置代码

```nginx
location / {
    if (!-e $request_filename) {
        rewrite ^(.*)$ /index.php?s=/$1 last;
    }
}
```

---

## 🎯 核心作用

**伪静态**（URL Rewrite）的作用是将**用户友好的 URL** 重写为 **PHP 能够处理的 URL**，实现：
1. **隐藏 `index.php` 入口文件**
2. **美化 URL 地址**
3. **支持 ThinkPHP 的路由机制**

---

## 🔍 逐行解析

### 1️⃣ `location /`
```nginx
location / {
```
- **作用**：匹配所有以 `/` 开头的请求（即网站的所有 URL）
- **范围**：整个网站的所有路径

---

### 2️⃣ `if (!-e $request_filename)`
```nginx
if (!-e $request_filename) {
```
- **`-e`**：检查文件或目录是否存在
- **`!`**：逻辑取反（不存在）
- **`$request_filename`**：Nginx 内置变量，表示请求的完整文件路径

**含义**：如果请求的文件/目录**不存在**，则执行下面的重写规则

**为什么需要这个判断？**
- ✅ **让静态文件直接访问**：如果请求的是 `css/style.css`、`js/app.js`、`images/logo.png` 这些**实际存在的文件**，Nginx 会直接返回，**不会重写**
- ✅ **只重写不存在的路径**：如 `/admin/index/index` 这个路径在磁盘上不存在，才需要重写到 `index.php` 处理

---

### 3️⃣ `rewrite ^(.*)$ /index.php?s=/$1 last;`
```nginx
rewrite ^(.*)$ /index.php?s=/$1 last;
```

#### 关键词解释：

| 关键词 | 说明 |
|--------|------|
| `rewrite` | Nginx 的 URL 重写指令 |
| `^(.*)$` | 正则表达式：匹配整个请求路径 |
| `/index.php?s=/$1` | 重写后的目标地址 |
| `last` | 重写后继续处理其他规则 |

#### 正则表达式分解：

- **`^`**：匹配字符串开头
- **`(.*)`**：捕获任意字符（`.` = 任意字符，`*` = 0 次或多次）
  - 括号 `()` 表示**捕获组**，内容会保存到 `$1` 变量
- **`$`**：匹配字符串结尾

**含义**：匹配整个请求路径，并保存到 `$1` 变量

#### 重写目标 `/index.php?s=/$1`：

- **`/index.php`**：ThinkPHP 的入口文件
- **`?s=/$1`**：GET 参数，将原始路径传递给 ThinkPHP
  - `$1` 就是上面正则表达式捕获的内容

#### `last` 标志：

- 停止处理当前 `rewrite` 规则
- 用新的 URI 重新搜索 `location` 配置
- 确保 `/index.php` 能被后续的 `location ~ \.php$` 处理

---

## 🌰 实际案例演示

### 案例 1：访问后台管理页面

**用户访问**：
```
http://localhost/admin/index/index
```

**处理流程**：

1️⃣ **Nginx 接收请求**
```
请求路径：/admin/index/index
```

2️⃣ **检查文件是否存在**
```nginx
if (!-e $request_filename)
```
检查 `/public/admin/index/index` 文件是否存在？
- ❌ **不存在** → 继续执行 `rewrite`

3️⃣ **执行正则匹配**
```nginx
rewrite ^(.*)$ /index.php?s=/$1 last;
```
- 匹配：`^(.*)$` 捕获到 `/admin/index/index`
- 保存到：`$1 = /admin/index/index`

4️⃣ **URL 重写**
```
原始：/admin/index/index
重写为：/index.php?s=/admin/index/index
```

5️⃣ **传递给 PHP 处理**
```nginx
location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    # ...
}
```
Nginx 将请求交给 PHP-FPM 处理

6️⃣ **ThinkPHP 路由解析**
```php
// index.php 接收参数
$_GET['s'] = '/admin/index/index'

// ThinkPHP 解析路由
模块(module)：admin
控制器(controller)：index
方法(action)：index

// 最终执行
application/admin/controller/Index.php 的 index() 方法
```

---

### 案例 2：访问 API 接口

**用户访问**：
```
http://localhost/addons/shopro/index/init
```

**重写结果**：
```
/index.php?s=/addons/shopro/index/init
```

**ThinkPHP 解析**：
```
模块：addons
控制器：shopro/index
方法：init
```

---

### 案例 3：访问静态资源

**用户访问**：
```
http://localhost/static/css/style.css
```

**处理流程**：

1️⃣ **检查文件是否存在**
```nginx
if (!-e $request_filename)
```
检查 `/public/static/css/style.css` 是否存在？
- ✅ **存在** → **不执行 rewrite**

2️⃣ **直接返回文件**
```
Nginx 直接返回 style.css 文件内容
不会传递给 PHP 处理
```

---

## ❌ 如果不配置伪静态会怎样？

### 问题 1：必须带上 `index.php`

**没有伪静态**：
```
❌ http://localhost/admin/index/index  → 404 Not Found
✅ http://localhost/index.php/admin/index/index  → 正常访问
```

### 问题 2：URL 不美观

```
❌ http://localhost/index.php/addons/shopro/index/init
✅ http://localhost/addons/shopro/index/init
```

### 问题 3：前端路由无法正常工作

```
前端请求：/addons/shopro/index/init
没有伪静态：Nginx 返回 404
有伪静态：重写到 /index.php?s=/addons/shopro/index/init → ThinkPHP 处理
```

---

## 🔄 完整的请求处理流程图

```
用户浏览器
    ↓
访问：http://localhost/admin/index/index
    ↓
Nginx 接收请求
    ↓
[伪静态规则]
    ↓
检查文件是否存在？
    ├─ 是 → 直接返回静态文件
    └─ 否 → 继续
        ↓
    正则匹配：^(.*)$
        ↓
    捕获：/admin/index/index
        ↓
    重写为：/index.php?s=/admin/index/index
        ↓
[location ~ \.php$]
    ↓
交给 PHP-FPM 处理
    ↓
PHP 执行 public/index.php
    ↓
ThinkPHP 框架启动
    ↓
路由解析：admin/index/index
    ↓
执行控制器方法
    ↓
返回结果给 Nginx
    ↓
Nginx 返回给用户浏览器
```

---

## 🛠️ 配置方法（phpstudy）

### 方式 1：使用预设模板（推荐）

1. 打开 phpstudy
2. 找到网站管理
3. 点击网站的 "设置" 或 "管理"
4. 找到 "伪静态" 选项卡
5. 从下拉菜单选择 **"ThinkPHP"** 预设
6. 点击保存
7. 重启 Nginx

### 方式 2：手动输入

在"伪静态"文本框中输入：
```nginx
location / {
    if (!-e $request_filename) {
        rewrite ^(.*)$ /index.php?s=/$1 last;
    }
}
```

---

## ⚠️ 常见问题

### Q1：为什么配置了伪静态还是 404？

**可能原因**：
1. ❌ Nginx 没有重启
2. ❌ 网站根目录指向错误（必须指向 `public` 目录）
3. ❌ 伪静态规则格式错误

**解决方法**：
```bash
# 1. 检查 Nginx 配置
phpstudy → 网站设置 → 运行目录 → 确保是 /public

# 2. 重新配置伪静态（精确复制）
location / {
    if (!-e $request_filename) {
        rewrite ^(.*)$ /index.php?s=/$1 last;
    }
}

# 3. 重启 Nginx
phpstudy → 重启 Nginx
```

### Q2：静态资源加载失败？

**原因**：伪静态规则不应该重写静态文件

**检查**：确保有 `if (!-e $request_filename)` 判断，让真实存在的文件直接访问

### Q3：为什么要用 `?s=` 参数？

这是 **ThinkPHP 的 URL 兼容模式**：
- `index.php?s=/module/controller/action`
- ThinkPHP 会从 `$_GET['s']` 获取路由信息
- 这是框架约定的参数名

---

## 📚 相关文档

- [ThinkPHP 5.0 URL 访问](https://www.kancloud.cn/manual/thinkphp5/118029)
- [Nginx Rewrite 规则](http://nginx.org/en/docs/http/ngx_http_rewrite_module.html)

---

## ✅ 总结

| 项目 | 说明 |
|------|------|
| **核心作用** | 隐藏 `index.php`，美化 URL |
| **工作原理** | 将不存在的路径重写到 `index.php` |
| **必要性** | 没有伪静态，所有 URL 必须带 `index.php` |
| **配置位置** | phpstudy → 网站设置 → 伪静态 |
| **重启要求** | 配置后必须重启 Nginx |

---

**文档创建时间**：2025-10-19  
**适用版本**：ThinkPHP 5.x + Nginx

